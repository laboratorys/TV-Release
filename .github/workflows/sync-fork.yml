name: Sync Fork (Rebase Mode)
on:
  schedule:
    - cron: '0 16 * * *'  # UTC 16:00 (北京时间 00:00)
    - cron: '0 4 * * *'   # UTC 04:00 (北京时间 12:00)
  workflow_dispatch:
    inputs:
      upstream_branch:
        description: '上游分支名称（如 fongmi）'
        required: false
        default: 'fongmi'

env:
  UPSTREAM_BRANCH: ${{ inputs.upstream_branch || 'fongmi' }}
  LOCAL_BRANCH: 'lab' # 你的魔改分支名

jobs:
  rebase-sync:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout 代码 (先尝试拉取整个仓库历史)
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.CUSTOM_GITHUB_TOKEN }}

      # 2. 设置 Git 身份
      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 3. 添加并拉取上游
      - name: Add Upstream and Fetch
        run: |
          git remote add upstream https://github.com/FongMi/TV.git
          git fetch upstream ${{ env.UPSTREAM_BRANCH }}

      # 4. 核心逻辑：检查 lab 分支是否存在，不存在则创建
      - name: Check or Create Local Branch
        run: |
          # 检查远程 origin 是否存在 lab 分支
          if git ls-remote --exit-code --heads origin ${{ env.LOCAL_BRANCH }}; then
            echo "Branch ${{ env.LOCAL_BRANCH }} exists, checking it out..."
            git checkout ${{ env.LOCAL_BRANCH }}
          else
            echo "Branch ${{ env.LOCAL_BRANCH }} does not exist, creating from upstream/${{ env.UPSTREAM_BRANCH }}..."
            # 基于上游指定分支创建一个全新的本地 lab 分支
            git checkout -b ${{ env.LOCAL_BRANCH }} upstream/${{ env.UPSTREAM_BRANCH }}
            # 立即推送到远程，确保初始化成功
            git push origin ${{ env.LOCAL_BRANCH }}
          fi

      # 5. 执行 Rebase (仅在分支已存在且有更新时有意义)
      - name: Rebase onto Upstream
        id: rebase
        run: |
          # 确保当前在 lab 分支
          git checkout ${{ env.LOCAL_BRANCH }}
          # 执行 rebase
          if git rebase upstream/${{ env.UPSTREAM_BRANCH }}; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=conflict" >> $GITHUB_OUTPUT
            git rebase --abort
          fi

      # 6. 如果 Rebase 成功（或新创建），强制推送
      - name: Push Changes
        if: steps.rebase.outputs.status == 'success'
        run: |
          git push --force origin ${{ env.LOCAL_BRANCH }}

      # 7. 报告冲突
      - name: Report Conflict
        if: steps.rebase.outputs.status == 'conflict'
        run: |
          echo "::error::Rebase 冲突！请在本地处理冲突后推送到远程。"
          exit 1