name: Sync Fork with Upstream
on:
  schedule:
    - cron: '0 16 * * *'  # UTC 16:00 (CST 00:00)
    - cron: '0 4 * * *'   # UTC 04:00 (CST 12:00)
  workflow_dispatch: # Allow manual trigger
jobs:
  sync-fork:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.CUSTOM_GITHUB_TOKEN }}

      - name: Set up Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Add upstream remote
        run: git remote add upstream https://github.com/FongMi/TV.git

      - name: Fetch upstream changes
        run: git fetch upstream release

      - name: Try to merge upstream changes
        id: merge
        run: |
          # Try to merge without committing to check for conflicts
          if git merge --no-commit --no-ff upstream/release; then
            echo "status=success" >> $GITHUB_OUTPUT
            git merge --abort  # Clean up the test merge
          else
            echo "status=conflict" >> $GITHUB_OUTPUT
            git merge --abort  # Clean up the failed merge
          fi

      - name: Merge if no conflicts
        if: steps.merge.outputs.status == 'success'
        run: |
          git merge --no-ff upstream/release
          git push origin lab

      - name: Report conflicts
        if: steps.merge.outputs.status == 'conflict'
        run: |
          echo "Merge conflict detected between upstream/release and local lab branch"
          exit 1