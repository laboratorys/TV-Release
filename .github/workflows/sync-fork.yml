name: Sync Fork with Upstream
on:
  schedule:
    - cron: '0 16 * * *'  # UTC 16:00 (CST 00:00)
    - cron: '0 4 * * *'   # UTC 04:00 (CST 12:00)
  workflow_dispatch:
jobs:
  sync-fork:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.CUSTOM_GITHUB_TOKEN }}
          ref: lab

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: git remote add upstream https://github.com/FongMi/TV.git

      - name: Fetch upstream changes
        run: git fetch upstream release

      - name: Check if merge needed
        id: check-merge
        run: |
          # 检查是否有需要合并的提交
          if [ -z "$(git log lab..upstream/release --oneline)" ]; then
            echo "status=no_changes" >> $GITHUB_OUTPUT
          else
            echo "status=needs_merge" >> $GITHUB_OUTPUT
          fi

      - name: Try to merge upstream changes
        id: merge
        if: steps.check-merge.outputs.status == 'needs_merge'
        run: |
          git checkout lab
          if git merge --no-commit --no-ff --allow-unrelated-histories upstream/release; then
            echo "status=success" >> $GITHUB_OUTPUT
            git merge --abort
          else
            echo "status=conflict" >> $GITHUB_OUTPUT
            git merge --abort
          fi

      - name: Merge if no conflicts
        if: steps.check-merge.outputs.status == 'needs_merge' && steps.merge.outputs.status == 'success'
        run: |
          git checkout lab
          git merge --no-ff --allow-unrelated-histories upstream/release
          git push origin lab

      - name: Report conflicts
        if: steps.merge.outputs.status == 'conflict'
        run: |
          echo "::error::合并冲突: 上游 release 分支与本地 lab 分支存在冲突"
          exit 1

      - name: Report already up to date
        if: steps.check-merge.outputs.status == 'no_changes'
        run: |
          echo "::notice::分支已是最新状态，无需合并"