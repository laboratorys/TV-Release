name: Sync Fork with Upstream
on:
  schedule:
    - cron: '0 16 * * *'  # UTC 16:00 (CST 00:00)
    - cron: '0 4 * * *'   # UTC 04:00 (CST 12:00)
  workflow_dispatch:
    inputs:
      upstream_branch:
        description: '上游分支名称'
        required: false
        default: 'fongmi'

env:
  UPSTREAM_BRANCH: ${{ inputs.upstream_branch || 'fongmi' }}
  LOCAL_BRANCH: 'lab'

jobs:
  sync-fork:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.CUSTOM_GITHUB_TOKEN }}
          ref: main
      - name: Create and checkout lab branch (if not exists)
        run: |
          if ! git ls-remote --exit-code --heads origin ${{ env.LOCAL_BRANCH }}; then
            echo "Branch ${{ env.LOCAL_BRANCH }} does not exist, creating it..."
            git checkout -b ${{ env.LOCAL_BRANCH }}
            git push origin ${{ env.LOCAL_BRANCH }}
          else
            echo "Branch ${{ env.LOCAL_BRANCH }} already exists, checking out..."
            git fetch origin ${{ env.LOCAL_BRANCH }}:${{ env.LOCAL_BRANCH }}
            git checkout ${{ env.LOCAL_BRANCH }}
          fi
      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      - name: Add upstream remote
        run: git remote add upstream https://github.com/FongMi/TV.git
      - name: Fetch upstream changes
        run: git fetch upstream ${{ env.UPSTREAM_BRANCH }}
      - name: Check if merge needed
        id: check-merge
        run: |
          if [ -z "$(git log ${{ env.LOCAL_BRANCH }}..upstream/${{ env.UPSTREAM_BRANCH }} --oneline)" ]; then
            echo "status=no_changes" >> $GITHUB_OUTPUT
          else
            echo "status=needs_merge" >> $GITHUB_OUTPUT
          fi
      - name: Try to merge upstream changes
        id: merge
        if: steps.check-merge.outputs.status == 'needs_merge'
        run: |
          git checkout ${{ env.LOCAL_BRANCH }}
          if git merge --no-commit --no-ff --allow-unrelated-histories upstream/${{ env.UPSTREAM_BRANCH }}; then
            echo "status=success" >> $GITHUB_OUTPUT
            git merge --abort
          else
            echo "status=conflict" >> $GITHUB_OUTPUT
            git merge --abort
          fi
      - name: Merge if no conflicts
        if: steps.check-merge.outputs.status == 'needs_merge' && steps.merge.outputs.status == 'success'
        run: |
          git checkout ${{ env.LOCAL_BRANCH }}
          git merge --no-ff --allow-unrelated-histories upstream/${{ env.UPSTREAM_BRANCH }}
          git push origin ${{ env.LOCAL_BRANCH }}
      - name: Report conflicts
        if: steps.merge.outputs.status == 'conflict'
        run: |
          echo "::error::合并冲突: 上游 ${{ env.UPSTREAM_BRANCH }} 分支与本地 ${{ env.LOCAL_BRANCH }} 分支存在冲突"
          exit 1
      - name: Report already up to date
        if: steps.check-merge.outputs.status == 'no_changes'
        run: |
          echo "::notice::分支已是最新状态，无需合并"