name: Sync Fork with Upstream
on:
  schedule:
    - cron: '0 16 * * *'  # UTC 16:00 (CST 00:00)
    - cron: '0 4 * * *'   # UTC 04:00 (CST 12:00)
  workflow_dispatch:
    inputs:
      upstream_branch:
        description: '上游分支名称（如 fongmi）'
        required: false
        default: 'fongmi'

env:
  UPSTREAM_BRANCH: ${{ inputs.upstream_branch || 'fongmi' }}
  LOCAL_BRANCH: 'lab'

jobs:
  sync-fork:
    runs-on: ubuntu-latest
    steps:
      # 1. 先 checkout 当前仓库的默认分支（如 main）
      - name: Checkout current repo (main branch)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.CUSTOM_GITHUB_TOKEN }}
          ref: main  # 假设你的仓库有 main 或 master 分支

      # 2. 设置 Git 身份
      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 3. 添加上游仓库（FongMi/TV）
      - name: Add upstream remote
        run: git remote add upstream https://github.com/FongMi/TV.git

      # 4. 如果 lab 分支不存在，基于 upstream/fongmi 创建并强制推送
      - name: Create or checkout lab branch
        run: |
          # 检查远程是否存在 lab 分支
          if ! git ls-remote --exit-code --heads origin ${{ env.LOCAL_BRANCH }}; then
            echo "Branch ${{ env.LOCAL_BRANCH }} does not exist, creating from upstream/${{ env.UPSTREAM_BRANCH }}..."
            git fetch upstream ${{ env.UPSTREAM_BRANCH }}
            git checkout -b ${{ env.LOCAL_BRANCH }} upstream/${{ env.UPSTREAM_BRANCH }}
            git push --force origin ${{ env.LOCAL_BRANCH }}
          else
            echo "Branch ${{ env.LOCAL_BRANCH }} already exists, checking out..."
            git fetch origin ${{ env.LOCAL_BRANCH }}
            git checkout ${{ env.LOCAL_BRANCH }}
          fi

      # 5. 拉取上游最新代码
      - name: Fetch upstream changes
        run: git fetch upstream ${{ env.UPSTREAM_BRANCH }}

      # 6. 检查是否需要合并
      - name: Check if merge needed
        id: check-merge
        run: |
          if [ -z "$(git log ${{ env.LOCAL_BRANCH }}..upstream/${{ env.UPSTREAM_BRANCH }} --oneline)" ]; then
            echo "status=no_changes" >> $GITHUB_OUTPUT
          else
            echo "status=needs_merge" >> $GITHUB_OUTPUT
          fi

      # 7. 尝试合并（模拟，检查冲突）
      - name: Try to merge upstream changes
        id: merge
        if: steps.check-merge.outputs.status == 'needs_merge'
        run: |
          git checkout ${{ env.LOCAL_BRANCH }}
          if git merge --no-commit --no-ff --allow-unrelated-histories upstream/${{ env.UPSTREAM_BRANCH }}; then
            echo "status=success" >> $GITHUB_OUTPUT
            git merge --abort
          else
            echo "status=conflict" >> $GITHUB_OUTPUT
            git merge --abort
          fi

      # 8. 如果没有冲突，正式合并
      - name: Merge if no conflicts
        if: steps.check-merge.outputs.status == 'needs_merge' && steps.merge.outputs.status == 'success'
        run: |
          git checkout ${{ env.LOCAL_BRANCH }}
          git merge --no-ff --allow-unrelated-histories upstream/${{ env.UPSTREAM_BRANCH }}
          git push origin ${{ env.LOCAL_BRANCH }}

      # 9. 报告冲突
      - name: Report conflicts
        if: steps.merge.outputs.status == 'conflict'
        run: |
          echo "::error::合并冲突: 上游 ${{ env.UPSTREAM_BRANCH }} 分支与本地 ${{ env.LOCAL_BRANCH }} 分支存在冲突"
          exit 1

      # 10. 如果已经是最新的，输出提示
      - name: Report already up to date
        if: steps.check-merge.outputs.status == 'no_changes'
        run: |
          echo "::notice::分支已是最新状态，无需合并"