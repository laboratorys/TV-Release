name: Sync Fork (Rebase Mode)
on:
  schedule:
    - cron: '0 16 * * *'  # UTC 16:00 (北京时间 00:00)
    - cron: '0 4 * * *'   # UTC 04:00 (北京时间 12:00)
  workflow_dispatch:
    inputs:
      upstream_branch:
        description: '上游分支名称（如 fongmi）'
        required: false
        default: 'fongmi' # 已修改默认值为 fongmi

env:
  UPSTREAM_BRANCH: ${{ inputs.upstream_branch || 'fongmi' }} # 兜底逻辑同步修改
  LOCAL_BRANCH: 'lab' # 你的魔改分支

jobs:
  rebase-sync:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout 代码，必须设置 fetch-depth: 0 才能获取完整历史进行 rebase
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.CUSTOM_GITHUB_TOKEN }}
          ref: ${{ env.LOCAL_BRANCH }}

      # 2. 设置 Git 身份
      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 3. 添加并拉取上游
      - name: Add Upstream and Fetch
        run: |
          git remote add upstream https://github.com/FongMi/TV.git
          git fetch upstream ${{ env.UPSTREAM_BRANCH }}

      # 4. 执行 Rebase
      - name: Rebase onto Upstream
        id: rebase
        run: |
          # 尝试将本地分支 rebase 到上游分支之上
          if git rebase upstream/${{ env.UPSTREAM_BRANCH }}; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=conflict" >> $GITHUB_OUTPUT
            # 如果发生冲突，必须撤销 rebase 状态，否则后续 push 会出错
            git rebase --abort
          fi

      # 5. 如果 Rebase 成功，强制推送到自己的仓库
      - name: Push Changes
        if: steps.rebase.outputs.status == 'success'
        run: |
          # Rebase 会改变提交历史，必须使用 --force
          git push --force origin ${{ env.LOCAL_BRANCH }}

      # 6. 报告冲突
      - name: Report Conflict
        if: steps.rebase.outputs.status == 'conflict'
        run: |
          echo "::error::Rebase 冲突！上游 fongmi 分支与你的 lab 分支在同一处代码有变动，请在本地手动解决。"
          exit 1