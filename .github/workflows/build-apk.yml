name: Build and Release APK
on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 17,5 * * *'
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
      R2_BUCKET_NAME: "apk"
      ANDROID_BUILD_TOOLS: "34.0.0" # æŒ‡å®šæ„å»ºå·¥å…·ç‰ˆæœ¬
      GRADLE_OPTS: "-Dorg.gradle.caching=true -Dorg.gradle.parallel=true"
      ANDROID_HOME: /usr/local/lib/android/sdk
    steps:
      # 1. æ‹‰å–ç›®æ ‡ä»“åº“ä»£ç 
      - name: ğŸ›’ Checkout TV project
        uses: actions/checkout@v5
        with:
          repository: laboratorys/TV-Release # ç›®æ ‡ä»“åº“
          ref: lab # æŒ‡å®šåˆ†æ”¯
          path: tv-app # ä»£ç å­˜æ”¾ç›®å½•
          fetch-depth: 0
        env:
          GITHUB_TOKEN: ${{ secrets.CUSTOM_GITHUB_TOKEN }}
      - name: ğŸ“¥ Download last_build_commit.txt from latest release
        run: |
          cd tv-app
          if curl -fsSL -o last_build_commit.txt "https://github.com/laboratorys/TV-Release/releases/latest/download/last_build_commit.txt"; then
            echo "ğŸ“¥ Retrieved previous build timestamp"
          else
            echo "âš ï¸ No previous build record found, initializing..."
            echo "0" > last_build_commit.txt
          fi
      # 2. åŠ¨æ€åˆ¤æ–­æ˜¯å¦è·³è¿‡æ„å»ºæ£€æŸ¥
      - name: âš™ï¸ Build Control
        id: build-control
        run: |
          # æ‰‹åŠ¨è§¦å‘æ—¶å¼ºåˆ¶æ„å»º
          if [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" ]]; then
            echo "ğŸ¯ æ‰‹åŠ¨è§¦å‘ - å¼ºåˆ¶æ„å»º"
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # å®šæ—¶ä»»åŠ¡æ—¶æ£€æŸ¥æ–°æäº¤
          if [[ "$GITHUB_EVENT_NAME" == "schedule" ]]; then
            echo "â° å®šæ—¶ä»»åŠ¡ - æ£€æŸ¥æ–°æäº¤..."
            cd tv-app
            LAST_COMMIT_DATE=$(git log -1 --format=%ct)
          
            if [[ -f last_build_commit.txt ]]; then
              PREV_COMMIT_DATE=$(cat last_build_commit.txt)
              if [[ $LAST_COMMIT_DATE -le $PREV_COMMIT_DATE ]]; then
                echo "ğŸ•’ æ— æ–°æäº¤ - è·³è¿‡æ„å»º"
                echo "should_build=false" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi
          
            echo $LAST_COMMIT_DATE > last_build_commit.txt
            echo "ğŸš€ å‘ç°æ–°æäº¤ - å¼€å§‹æ„å»º"
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            # å…¶ä»–æƒ…å†µï¼ˆå¦‚tagè§¦å‘ï¼‰é»˜è®¤æ„å»º
            echo "ğŸ”– æ ‡ç­¾è§¦å‘ - æ‰§è¡Œæ„å»º"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi
      - name: ğŸ“Œ Extract versionName
        if: steps.build-control.outputs.should_build == 'true'
        id: version
        working-directory: tv-app
        run: |
          # ä½¿ç”¨ grep æå– versionName
          VERSION=$(grep -oP 'versionName\s+"\K[0-9.]+(?=")' app/build.gradle)
          echo "Extracted versionName: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      # 3. ç¯å¢ƒè®¾ç½®
      - name: â˜• Set up JDK 17
        if: steps.build-control.outputs.should_build == 'true'
        uses: actions/setup-java@v5
        with:
          java-version: "17"
          distribution: "temurin"

      - name: ğŸ¤– Setup Android SDK
        if: steps.build-control.outputs.should_build == 'true'
        uses: android-actions/setup-android@v3
        with:
          packages: 'tools platform-tools build-tools;34.0.0'
      - name: ğŸ”§ Configure Build Tools Path
        if: steps.build-control.outputs.should_build == 'true'
        run: |
          # ç¡®ä¿æ„å»ºå·¥å…·è·¯å¾„åœ¨PATHä¸­
          echo "$ANDROID_HOME/build-tools/${{ env.ANDROID_BUILD_TOOLS }}" >> $GITHUB_PATH
          echo "Build tools path configured"
      - uses: actions/setup-python@v6
        with:
          python-version: '3.10'
      # 4. ç¼“å­˜ Gradle ä¾èµ–ï¼ˆåŠ é€Ÿæ„å»ºï¼‰
      - name: ğŸ—ï¸ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            tv-app/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('tv-app/gradle/wrapper/gradle-wrapper.properties', 'tv-app/build.gradle') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: Download AAR Files
        if: false
        working-directory: tv-app # è¿›å…¥ç›®æ ‡ä»“åº“ç›®å½•
        run: |
          curl -sSLo download_aars.sh https://raw.githubusercontent.com/laboratorys/TV-Release/refs/heads/main/scripts/download_aars.sh
          chmod +x download_aars.sh
          ./download_aars.sh
      # 5. æ„å»º APK
      - name: ğŸ”¨ Build & Sign APK
        if: steps.build-control.outputs.should_build == 'true'
        working-directory: tv-app # è¿›å…¥ç›®æ ‡ä»“åº“ç›®å½•
        env:
          KEYSTORE: ${{ secrets.KEYSTORE }} # Base64 ç¼–ç çš„ç­¾åæ–‡ä»¶
          KEYSTORE_PASS: ${{ secrets.KEYSTORE_PASS }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASS: ${{ secrets.KEY_PASS }}
        run: |
          # è§£ç ç­¾åæ–‡ä»¶
          echo "ğŸ”‘ Decoding keystore..."
          echo "$KEYSTORE" | base64 -d > keystore.jks
          
          # èµ‹äºˆ gradlew æ‰§è¡Œæƒé™
          chmod +x gradlew
          
          # æ‰§è¡Œ Gradle ç­¾åæ„å»º
          echo "ğŸš€ Building APK..."
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=$(pwd)/keystore.jks \
            -Pandroid.injected.signing.store.password="$KEYSTORE_PASS" \
            -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$KEY_PASS" \
            --console=plain --no-daemon
          
          mkdir -p release_apks
          echo "ğŸ” Collecting signed APKs..."
          
          find app/build/outputs/apk -type f -name "*.apk" ! -name "*unsigned*" | while read -r apk; do
            # æå–æ–‡ä»¶åä¿¡æ¯ç”¨äºå½’æ¡£ (ä¾‹å¦‚: leanback-arm64-v8a.apk)
            # è¿™é‡Œç®€å•å¤„ç†ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦ä¿ç•™åŸå§‹è·¯å¾„æˆ–é‡å‘½å
            FILENAME=$(basename "$apk")
            echo "âœ… Found Signed APK: $FILENAME"
            cp "$apk" "release_apks/$FILENAME"
          done
          rm -f keystore.jks
          
          # 6. éªŒè¯ (å¯é€‰)
          if [ -z "$(ls -A release_apks/)" ]; then
            echo "âŒ Error: No signed APK found! Check Gradle build logs."
            exit 1
          fi
          echo "ğŸ“¦ ç”Ÿæˆçš„ APK æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -lh release_apks/
      - name: ğŸ“ Process Update JSON
        if: steps.build-control.outputs.should_build == 'true'
        run: |
          curl -sSLo process_json.sh https://raw.githubusercontent.com/laboratorys/TV-Release/refs/heads/main/scripts/process_json.sh
          chmod +x process_json.sh
          ./process_json.sh "${{ steps.version.outputs.version }}" "ä¸Šæ¸¸ä»“åº“åŒæ­¥æ›´æ–°"
      - name: Generate current time
        id: datetime
        run: echo "CURRENT_TIME=$(date -u +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
      # 7. åˆ›å»º Release å¹¶ä¸Šä¼  APK
      - name: ğŸš€ Upload to Release
        if: steps.build-control.outputs.should_build == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.version.outputs.version }}" # ä½¿ç”¨ versionName ä½œä¸ºæ ‡ç­¾
          name: "ğŸ“± Release v${{ steps.version.outputs.version }}"
          body: |
            âœ¨ Multi-ABI APK Build
            - Version: ${{ steps.version.outputs.version }}
            - Build Date: ${{ steps.datetime.outputs.CURRENT_TIME }}
            - Variants: mobile, leanback
            - ABIs: armeabi_v7a, arm64_v8a
          files: |
            tv-app/release_apks/*.apk
            tv-app/last_build_commit.txt
            processed_json/leanback.json
            processed_json/mobile.json
          token: ${{ secrets.GITHUB_TOKEN }}
          # 8. ä¸Šä¼ åˆ° Cloudflare R2
      - name: â˜ï¸ Sync to Cloudflare R2 (Keep Latest Only)
        if: steps.build-control.outputs.should_build == 'true'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
        run: |
          echo "ğŸ”„ åŒæ­¥æ–‡ä»¶åˆ° R2..."
          # ä½¿ç”¨ aws s3 sync å®ç°å¢é‡åŒæ­¥
          # --endpoint-url: R2 çš„è¿æ¥åœ°å€
          # --delete: å…³é”®å‚æ•°ï¼å¦‚æœ R2 ä¸Šæœ‰æ–‡ä»¶ä½†åœ¨æœ¬åœ° release_apks ä¸­ä¸å­˜åœ¨ï¼Œåˆ™åˆ é™¤ R2 ä¸Šçš„æ–‡ä»¶
          # è¿™æ ·å¯ä»¥ç¡®ä¿ R2 æ¡¶é‡Œæ°¸è¿œåªæœ‰æœ¬æ¬¡æ„å»ºç”Ÿæˆçš„æœ€æ–° APK
          echo "ğŸ“‚ Preparing JSON files for sync..."
          cp processed_json/leanback.json tv-app/release_apks/
          cp processed_json/mobile.json tv-app/release_apks/
          aws s3 sync tv-app/release_apks/ s3://${{ env.R2_BUCKET_NAME }}/tv/ \
          --endpoint-url ${{ secrets.R2_BUCKET_URL }} \
          --delete
      - name: ğŸ§¹ Purge Cloudflare CDN Cache
        # åªæœ‰å½“ä½ é…ç½®äº† CF_API_TOKEN æ—¶æ‰è¿è¡Œï¼Œé˜²æ­¢æŠ¥é”™
        if: steps.build-control.outputs.should_build == 'true' && env.CF_API_TOKEN != ''
        run: |
          echo "ğŸ§¼ æ­£åœ¨åˆ·æ–° Cloudflare ç¼“å­˜..."
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
          -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          --data '{
            "files": [
              "https://apk.vxsx.eu.org/tv/leanback.json",
              "https://apk.vxsx.eu.org/tv/mobile.json"
            ]
          }'
