name: Build and Release APK
on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 13,1 * * *'
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_BUILD_TOOLS: "34.0.0" # æŒ‡å®šæ„å»ºå·¥å…·ç‰ˆæœ¬
      GRADLE_OPTS: "-Dorg.gradle.daemon=false" # ç¦ç”¨Gradleå®ˆæŠ¤è¿›ç¨‹
    steps:
      # 1. æ‹‰å–ç›®æ ‡ä»“åº“ä»£ç 
      - name: ğŸ›’ Checkout TV project
        uses: actions/checkout@v5
        with:
          repository: laboratorys/TV # ç›®æ ‡ä»“åº“
          ref: lab # æŒ‡å®šåˆ†æ”¯
          path: tv-app # ä»£ç å­˜æ”¾ç›®å½•
          fetch-depth: 0
        env:
          GITHUB_TOKEN: ${{ secrets.CUSTOM_GITHUB_TOKEN }}
            # 2. åŠ¨æ€åˆ¤æ–­æ˜¯å¦è·³è¿‡æ„å»ºæ£€æŸ¥
      - name: âš™ï¸ Build Control
        id: build-control
        run: |
          # æ‰‹åŠ¨è§¦å‘æ—¶å¼ºåˆ¶æ„å»º
          if [[ ${{ github.event_name == 'workflow_dispatch' }} ]]; then
            echo "ğŸ¯ æ‰‹åŠ¨è§¦å‘ - å¼ºåˆ¶æ„å»º"
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # å®šæ—¶ä»»åŠ¡æ—¶æ£€æŸ¥æ–°æäº¤
          if [[ ${{ github.event_name == 'schedule' }} ]]; then
            echo "â° å®šæ—¶ä»»åŠ¡ - æ£€æŸ¥æ–°æäº¤..."
            cd tv-app
            LAST_COMMIT_DATE=$(git log -1 --format=%ct)
          
            if [[ -f last_build_commit.txt ]]; then
              PREV_COMMIT_DATE=$(cat last_build_commit.txt)
              if [[ $LAST_COMMIT_DATE -le $PREV_COMMIT_DATE ]]; then
                echo "ğŸ•’ æ— æ–°æäº¤ - è·³è¿‡æ„å»º"
                echo "should_build=false" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi
          
            echo $LAST_COMMIT_DATE > last_build_commit.txt
            echo "ğŸš€ å‘ç°æ–°æäº¤ - å¼€å§‹æ„å»º"
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            # å…¶ä»–æƒ…å†µï¼ˆå¦‚tagè§¦å‘ï¼‰é»˜è®¤æ„å»º
            echo "ğŸ”– æ ‡ç­¾è§¦å‘ - æ‰§è¡Œæ„å»º"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi
      - name: ğŸ“Œ Extract versionName
        if: steps.build-control.outputs.should_build == 'true'
        id: version
        working-directory: tv-app
        run: |
          # ä½¿ç”¨ grep æå– versionName
          VERSION=$(grep -oP 'versionName\s+"\K[0-9.]+(?=")' app/build.gradle)
          echo "Extracted versionName: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      # 3. ç¯å¢ƒè®¾ç½®
      - name: ğŸ› ï¸ Setup Environment
        if: steps.build-control.outputs.should_build == 'true'
        run: |
          # å®‰è£…å¿…è¦çš„æ„å»ºå·¥å…·
          yes | sdkmanager "build-tools;${{ env.ANDROID_BUILD_TOOLS }}"
          echo "$ANDROID_HOME/build-tools/${{ env.ANDROID_BUILD_TOOLS }}" >> $GITHUB_PATH
      - name: â˜• Set up JDK 17
        if: steps.build-control.outputs.should_build == 'true'
        uses: actions/setup-java@v5
        with:
          java-version: "17"
          distribution: "temurin"
      # 4. ç¼“å­˜ Gradle ä¾èµ–ï¼ˆåŠ é€Ÿæ„å»ºï¼‰
      - name: ğŸ—ï¸ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            tv-app/last_build_commit.txt
            tv-app/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('tv-app/gradle/wrapper/gradle-wrapper.properties', 'tv-app/build.gradle') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      # 5. æ„å»º APKï¼ˆéœ€æå‰é…ç½®ç­¾åä¿¡æ¯ï¼‰
      - name: ğŸ”¨ Build & Sign APK
        if: steps.build-control.outputs.should_build == 'true'
        working-directory: tv-app # è¿›å…¥ç›®æ ‡ä»“åº“ç›®å½•
        env:
          KEYSTORE: ${{ secrets.KEYSTORE }} # Base64 ç¼–ç çš„ç­¾åæ–‡ä»¶
          KEYSTORE_PASS: ${{ secrets.KEYSTORE_PASS }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASS: ${{ secrets.KEY_PASS }}
        run: |
          # è§£ç ç­¾åæ–‡ä»¶
          echo "ğŸ”‘ Decoding keystore..."
          echo "$KEYSTORE" | base64 -d > keystore.jks
          # èµ‹äºˆ gradlew æ‰§è¡Œæƒé™
          chmod +x gradlew
          # æ‰§è¡Œ Gradle ç­¾åæ„å»º
          echo "ğŸš€ Building signed APK..."
          ./gradlew assembleRelease --console=plain --no-daemon
           mkdir -p release_apks
          # å¤„ç†æ‰€æœ‰APKæ–‡ä»¶ï¼ˆåŒ…æ‹¬leanbackå’Œmobileå˜ä½“ï¼‰
          find app/build/outputs/apk -name "*.apk" ! -name "*unsigned*" | while read -r apk; do
          # æå–å˜ä½“åç§°ï¼ˆå¦‚leanbackArmeabi_v7aï¼‰
          VARIANT=$(echo "$apk" | grep -oE 'leanback|mobile')
          ABI=$(echo "$apk" | grep -oE 'armeabi_v7a|arm64_v8a')
          
          # ç”Ÿæˆè¾“å‡ºæ–‡ä»¶åï¼ˆå¦‚leanback-armeabi_v7a-aligned.apkï¼‰
          ALIGNED_APK="${VARIANT}-${ABI}-aligned.apk"
          SIGNED_APK="release_apks/${VARIANT}-${ABI}.apk"
          
          # å¯¹é½APK
          zipalign -p -f -v 4 "$apk" "$ALIGNED_APK"
          
          # ç­¾åAPK
          apksigner sign \
          --ks keystore.jks \
          --ks-key-alias "$KEY_ALIAS" \
          --ks-pass "pass:$KEYSTORE_PASS" \
          --key-pass "pass:$KEY_PASS" \
          --out "$SIGNED_APK" \
          "$ALIGNED_APK"
      
          # éªŒè¯ç­¾å
          apksigner verify -v "$SIGNED_APK"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f "$ALIGNED_APK"
          done
      
          # æ¸…ç†å¯†é’¥åº“
          rm -f keystore.jks
      
          # æ‰“å°æœ€ç»ˆAPKåˆ—è¡¨
          echo "ğŸ“¦ ç”Ÿæˆçš„APKæ–‡ä»¶ï¼š"
          ls -lh release_apks/
      # 7. åˆ›å»º Release å¹¶ä¸Šä¼  APK
      - name: ğŸš€ Upload to Release
        if: steps.build-control.outputs.should_build == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.version.outputs.version }}" # ä½¿ç”¨ versionName ä½œä¸ºæ ‡ç­¾
          name: "ğŸ“± Release v${{ steps.version.outputs.version }}"
          body: "âœ¨ Automated APK build\n\nVersion: ${{ steps.version.outputs.version }}\nBuilt with GitHub Actions"
          files: |
            tv-app/release_apks/*.apk
          token: ${{ secrets.CUSTOM_GITHUB_TOKEN }}