name: Build and Release APK

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  push:
    tags:
      - "v*" # æ ‡ç­¾è§¦å‘ï¼ˆä¾‹å¦‚ v1.0.0ï¼‰

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. æ‹‰å–ç›®æ ‡ä»“åº“ä»£ç 
      - name: ğŸ›’ Checkout TV project
        uses: actions/checkout@v5
        with:
          repository: laboratorys/TV # ç›®æ ‡ä»“åº“
          ref: release # æŒ‡å®šåˆ†æ”¯
          path: tv-app # ä»£ç å­˜æ”¾ç›®å½•
          fetch-depth: 0
      - name: ğŸ“Œ Extract versionName
        id: version
        working-directory: tv-app
        run: |
          # ä½¿ç”¨ grep æå– versionName
          VERSION=$(grep -oP 'versionName\s+\K[\'\"]?[0-9.]+[\'\"]?' app/build.gradle | tr -d "\"'")
          echo "Extracted versionName: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      # 2. è®¾ç½® JDK ç¯å¢ƒ
      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: "17"
          distribution: "temurin"

      # 3. é…ç½® Android SDK
      - name: ğŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v2

      # 4. ç¼“å­˜ Gradle ä¾èµ–ï¼ˆåŠ é€Ÿæ„å»ºï¼‰
      - name: ğŸ—ï¸ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      # 5. æ„å»º APKï¼ˆéœ€æå‰é…ç½®ç­¾åä¿¡æ¯ï¼‰
      - name: ğŸ”¨ Build signed APK
        working-directory: tv-app # è¿›å…¥ç›®æ ‡ä»“åº“ç›®å½•
        env:
          KEYSTORE: ${{ secrets.KEYSTORE }} # Base64 ç¼–ç çš„ç­¾åæ–‡ä»¶
          KEYSTORE_PASS: ${{ secrets.KEYSTORE_PASS }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASS: ${{ secrets.KEY_PASS }}
        run: |
          # è§£ç ç­¾åæ–‡ä»¶
          echo "ğŸ”‘ Decoding keystore..."
          echo "$KEYSTORE" | base64 -d > keystore.jks
          # èµ‹äºˆ gradlew æ‰§è¡Œæƒé™
          chmod +x gradlew
          # æ‰§è¡Œ Gradle ç­¾åæ„å»º
          echo "ğŸš€ Building signed APK..."
          ./gradlew assembleRelease --console=plain \
            -Pandroid.injected.signing.storeFile=$(pwd)/keystore.jks \
            -Pandroid.injected.signing.storePassword=$KEYSTORE_PASS \
            -Pandroid.injected.signing.keyAlias=$KEY_ALIAS \
            -Pandroid.injected.signing.keyPassword=$KEY_PASS
          echo "âœ… Build completed!"

      # 6. æ‰“å°ç”Ÿæˆçš„ APK æ–‡ä»¶åˆ—è¡¨
      - name: ğŸ“¦ List APK files
        working-directory: tv-app
        run: |
          echo "ğŸ“Œ å‘ç°ä»¥ä¸‹ APK æ–‡ä»¶ï¼š"
          find app/build/outputs/apk -name "*.apk" -exec ls -lh {} \;
          echo ""
          echo "ğŸ“Š æ–‡ä»¶è¯¦æƒ…ï¼š"
          echo "--------------------------------"
          find app/build/outputs/apk -name "*.apk" -exec du -h {} \;
          echo "--------------------------------"

      # 7. åˆ›å»º Release å¹¶ä¸Šä¼  APK
      - name: ğŸš€ Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.version.outputs.version }}" # ä½¿ç”¨ versionName ä½œä¸ºæ ‡ç­¾
          name: "ğŸ“± Release v${{ steps.version.outputs.version }}"
          body: "âœ¨ Automated APK build\n\nVersion: ${{ steps.version.outputs.version }}\nBuilt with GitHub Actions"
          files: |
            tv-app/app/build/outputs/apk/*/release/*.apk
          token: ${{ secrets.GITHUB_TOKEN }}ã€